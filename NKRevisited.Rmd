---
title: Nunery Keeton Revisited
author: Nikolaus Bates-Haus
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

## Introduction

In [@nunery2010], different management regimens were modeled to explore their
impact on carbon storage. This study used the Forest Vegetation Simulator (FVS)
to model carbon storage. Other models exist to predict carbon storage; we seek
to compare FVS with other models to understand their different predictions
for carbon storage under different management regimens.

## Identifying Stands

In [@nunery2010, Table 1], 32 plots are listed, with the first column,
"FIA plot code", identifying each plot. As described in [@shaw2019] and
[@shaw2020], the method used to compute FVS stand identifiers
subsequently changed, so these codes no longer align with the stand
identifiers in the FVS tables in the published FIA data.

```{r}
suppressPackageStartupMessages(library(tidyverse))
nk_table1 <- read_csv(
  "00_rawData/N-K_Table_1.csv",
  col_types = cols(`FIA plot code` = col_character())
)
knitr::kable(nk_table1, caption = 'Nunery Keeton Table 1')
```

To re-align NK's plot codes with the FIA published FVS stand
identifiers, we note that plot codes are a concatenation of other
fields, as described in [@shaw2020, Appendix A], Column list and
translation logic for records in FVS StandInit and PlotInit tables:

> StandInit_cond table:
> StandInit_cond.Stand_ID = concatenation of: STATECD(4) + INVYR(4) + CYCLE(2) +
> SUBCYCLE(2) + UNITCD(2) + COUNTYCD(3) + PLOT(5) + CONDID(1).
>
> StandInit_plot table:
> StandInit_plot.Stand_ID = concatenation of: PLOT.STATECD(4) + PLOT.INVYR(4) +
> PLOT.CYCLE(2) + PLOT.SUBCYCLE(2) + PLOT.UNITCD(2) + PLOT.COUNTYCD(3) +
> PLOT.PLOT(5).
> 
> PlotInit_plot table:
> PlotInit_plot.Stand_ID = concatenation of: PLOT.STATECD(4) + PLOT.INVYR(4) +
> PLOT.CYCLE(2) + PLOT.SUBCYCLE(2) + PLOT.UNITCD(2) + PLOT.COUNTYCD(3) +
> PLOT.PLOT(5).

```{r}
nk_table1_expanded <- nk_table1 |>
  mutate(STATECD = substr(`FIA plot code`, 1, 2)) |>
  mutate(INVYR = substr(`FIA plot code`, 3, 6)) |>
  mutate(UNITCD = substr(`FIA plot code`, 7, 8)) |>
  mutate(COUNTYCD = substr(`FIA plot code`, 9, 11)) |>
  mutate(PLOT = substr(`FIA plot code`, 12, 16))
nk_plot_codes <- nk_table1_expanded |>
  select(`FIA plot code`, STATECD, INVYR, UNITCD, COUNTYCD, PLOT)
knitr::kable(nk_plot_codes)
```

In particular, the way INVYR is assigned has changed, so the NK INVYR no
longer aligns with the inventory years in the FIA data.

```{r}
fia = DBI::dbConnect(RSQLite::SQLite(), '00_rawData/SQLite_FIADB_ENTIRE.db')
fia_cond = tbl(fia, 'COND')
# Note: we're joining tables across data providers so we have to copy one to the other.
# We do a right join so that we can copy the small table (nk_plot_codes) to
# the SQLite engine, where it can perform the join, while using the small table
# to select the output rows.
# We rename INVYR in NK to NK_INVYR, and in FIA to FIA_INVYR, so that we
# can compare the two.
matching_cond <- fia_cond |>
  rename(FIA_INVYR=INVYR) |>
  right_join(
    nk_plot_codes |> rename(NK_INVYR=INVYR),
    by=join_by(STATECD, UNITCD, COUNTYCD, PLOT),
    copy=TRUE
  ) |>
  collect()

# Group by STATECD, UNITCD, COUNTYCD and PLOT to see how NK INVYR does and
# doesn't line up with FIA INVYR
cond_grp <- matching_cond |>
  mutate(INVYR_MATCHES=ifelse(NK_INVYR==FIA_INVYR, 1, 0)) |>
  group_by(STATECD, UNITCD, COUNTYCD, PLOT) |>
  summarize(
    NUM_INVYR=n(),
    NUM_INVYR_MATCHES=sum(INVYR_MATCHES),
    .groups = "keep"
  )
knitr::kable(cond_grp)
```

To find corresponding Stand_IDs where INVYR does not align between the two data
sets, we note that the "Starting stand age" matches
`FIA.COND.STDAGE`, uniquely identifying all but one of
the stands used in NK.

```{r}
nk_plots_with_age <- nk_table1_expanded |>
  select(`FIA plot code`, STATECD, INVYR, UNITCD, COUNTYCD, PLOT,
         `Starting stand age`, `Slope (%)`, `Aspect (degrees)`,
         `Basal area (m2/ha)`) |>
  rename(NK_INVYR=INVYR)
fia_cond_with_age <- matching_cond |>
  select(STATECD, FIA_INVYR, CYCLE, SUBCYCLE, CONDID, UNITCD, COUNTYCD, PLOT,
         STDAGE, FLDAGE, SLOPE, ASPECT, BALIVE) |>
  left_join(
    nk_plots_with_age, by=join_by(STATECD, UNITCD, COUNTYCD, PLOT)
  )
unique_cond <- fia_cond_with_age |>
  filter(
    NK_INVYR==FIA_INVYR | (
      NK_INVYR!=FIA_INVYR & `Starting stand age`==STDAGE
    ),
    FIA_INVYR<=2005
  )
knitr::kable(unique_cond)
```

Matching on stand age results in a uniquely identified FIA condition for
each NK plot, except NK plot 2320030901702963, for which both inventory
years 2003 and 2008 match the stand age. Because all other plots match
stands in inventory years 1999 - 2005, we restrict to inventory years
\<= 2005, which results in selecting the 2003 inventory year for this
plot. We observe matching slope, aspect, and BALIVE metrics for these
stands, which confirms the match.

From these, we are able to construct contemporary Stand_IDs for the FIA
tables pre-built for FVS. Those IDs, and the number of matching rows
from the corresponding table, are:

```{r}
translated_stands <- unique_cond |>
  mutate(
    STATECD  = as.numeric(STATECD),
    UNITCD   = as.numeric(UNITCD),
    COUNTYCD = as.numeric(COUNTYCD),
    PLOT     = as.numeric(PLOT)
  ) |>
  mutate(STAND_ID_PLOT=sprintf(paste0(
    '%04d' , '%04d'    , '%02d', '%02d'  , '%02d', '%03d'  , '%05d'),
    STATECD, FIA_INVYR , CYCLE , SUBCYCLE, UNITCD, COUNTYCD, PLOT
  )) |>
  mutate(STAND_ID_COND=paste0(STAND_ID_PLOT, CONDID)) |>
  select(`FIA plot code`, STAND_ID_PLOT, STAND_ID_COND)
knitr::kable(translated_stands)
```

FVS_STANDINIT_PLOT

```{r}
fia_fvs_plotinit_plot = tbl(fia, 'FVS_PLOTINIT_PLOT')
matching_plotinit_plot <- fia_fvs_plotinit_plot |>
  right_join(translated_stands |> rename(STAND_ID=STAND_ID_PLOT),
    by=join_by(STAND_ID), copy=TRUE) |>
  collect()
matching_plotinit_plot_grp <- matching_plotinit_plot |>
  group_by(STAND_ID) |> summarize(NUM_PLOTS=n(), .groups = "keep") |>
  rename(FVS_PLOTINIT_PLOT=STAND_ID)

fia_fvs_standinit_cond = tbl(fia, 'FVS_STANDINIT_COND')
matching_standinit_cond <- fia_fvs_standinit_cond |>
  right_join(translated_stands |> rename(STAND_ID=STAND_ID_COND),
    by=join_by(STAND_ID), copy=TRUE) |>
  collect()
matching_standinit_cond_grp <- matching_standinit_cond |>
  group_by(STAND_ID) |> summarize(NUM_CONDS=n(), .groups = "keep") |>
  rename(FVS_STANDINIT_COND=STAND_ID)

fia_fvs_standinit_plot = tbl(fia, 'FVS_STANDINIT_PLOT')
matching_standinit_plot <- fia_fvs_standinit_plot |>
  right_join(translated_stands |> rename(STAND_ID=STAND_ID_PLOT),
    by=join_by(STAND_ID), copy=TRUE) |>
  collect()
matching_standinit_plot_grp <- matching_standinit_plot |>
  group_by(STAND_ID) |> summarize(NUM_COND_PLOTS=n(), .groups = "keep") |>
  rename(FVS_STANDINIT_PLOT=STAND_ID)

matching_stands <- translated_stands |>
  left_join(matching_plotinit_plot_grp, by=join_by(STAND_ID_PLOT==FVS_PLOTINIT_PLOT)) |>
  left_join(matching_standinit_cond_grp, by=join_by(STAND_ID_COND==FVS_STANDINIT_COND)) |>
  left_join(matching_standinit_plot_grp, by=join_by(STAND_ID_PLOT==FVS_STANDINIT_PLOT))

knitr::kable(matching_stands)
```


## References

Nunery, Jared & Keeton, William. (2010). Forest carbon storage in the
northeastern United States: Net effects of harvesting frequency,
post-harvest retention, and wood products. Forest Ecology and
Management. 259. 1363-1375. 10.1016/j.foreco.2009.12.029.

Shaw, John & Gagnon, Aaron. (2019). Field Note: A New Conversion of
Forest Inventory and Analysis Data for Use in the Forest Vegetation
Simulator. Journal of Forestry. 118. 10.1093/jofore/fvz050.

Burrill, Elizabeth A.; DiTommaso, Andrea M.; Turner, Jeffery A.; Pugh,
Scott A.; Christensen, Glenn; Perry, Carol J.; Lepine, Lucie C.; Walker,
David M.; Conkling, Barbara L. 2024. The Forest Inventory and Analysis
Database, FIADB user guides, volume database description (version 9.2),
nationwide forest inventory (NFI). U.S. Department of Agriculture,
Forest Service. 1042 p. [Online]. Available at web address:
<https://www.fs.usda.gov/research/products/dataandtools/datasets/fia-datamart>

Shaw, John D. & Gagnon, Aaron. (2020). Quick-Start Guide to Forest
Inventory Analysis Data in the Forest vegetation Simulator. U.S.
Department of Agriculture, Forest Service. 25 p. [Online]. Available at
web address:
<https://www.fs.usda.gov/fvs/documents/FIA_Data_Quick_Start_Guide_20200914.pdf>
